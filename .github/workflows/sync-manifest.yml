# sync-manifest.yml
#
# Triggered when a GitHub release is published (not draft).
# Updates manifest.json, package.json, package-lock.json and versions.json
# in the repository to match the published release version.

name: Sync Manifest After Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  sync-manifest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Update manifest.json version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "üìù Updating manifest.json to version $VERSION"

          node -e "
          const fs = require('fs');
          const version = '$VERSION';
          const content = fs.readFileSync('manifest.json', 'utf8');
          const manifest = JSON.parse(content);
          const originalVersion = manifest.version;
          manifest.version = version;

          const useTabs = content.includes('\\t');
          const indent = useTabs ? '\\t' : '  ';
          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, indent) + '\\n');
          console.log('‚úÖ Updated manifest.json from', originalVersion, 'to', version);
          "

      - name: Update package.json version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "üì¶ Updating package.json to version $VERSION"

          node -e "
          const fs = require('fs');
          const version = '$VERSION';
          const content = fs.readFileSync('package.json', 'utf8');
          const pkg = JSON.parse(content);
          const originalVersion = pkg.version;
          pkg.version = version;

          const useTabs = content.includes('\\t');
          const indent = useTabs ? '\\t' : '  ';
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, indent) + '\\n');
          console.log('‚úÖ Updated package.json from', originalVersion, 'to', version);
          "

      - name: Update package-lock.json version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "üîí Updating package-lock.json to version $VERSION"

          if [ -f "package-lock.json" ]; then
            node -e "
            const fs = require('fs');
            const version = '$VERSION';
            const content = fs.readFileSync('package-lock.json', 'utf8');
            const lockfile = JSON.parse(content);
            const originalVersion = lockfile.version;

            lockfile.version = version;
            if (lockfile.packages && lockfile.packages['']) {
              lockfile.packages[''].version = version;
            }

            fs.writeFileSync('package-lock.json', JSON.stringify(lockfile, null, 2) + '\\n');
            console.log('‚úÖ Updated package-lock.json from', originalVersion, 'to', version);
            "
          else
            echo "‚ö†Ô∏è No package-lock.json found, skipping"
          fi

      - name: Update or create versions.json
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "üìã Updating versions.json with version $VERSION"

          node -e "
          const fs = require('fs');
          const version = '$VERSION';
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          const minAppVersion = manifest.minAppVersion || '0.15.0';

          let versions = {};
          let indent = '  ';

          if (fs.existsSync('versions.json')) {
            const content = fs.readFileSync('versions.json', 'utf8');
            versions = JSON.parse(content);
            indent = content.includes('\\t') ? '\\t' : '  ';
          }

          versions[version] = minAppVersion;

          const sortedVersions = {};
          Object.keys(versions)
            .sort((a, b) => {
              const aParts = a.split('.').map(Number);
              const bParts = b.split('.').map(Number);
              for (let i = 0; i < 3; i++) {
                if (aParts[i] !== bParts[i]) return bParts[i] - aParts[i];
              }
              return 0;
            })
            .forEach((key) => {
              sortedVersions[key] = versions[key];
            });

          fs.writeFileSync('versions.json', JSON.stringify(sortedVersions, null, indent) + '\\n');
          console.log('‚úÖ Updated versions.json with', version, '->', minAppVersion);
          "

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"

          if git diff --quiet HEAD -- manifest.json package.json package-lock.json versions.json; then
            echo "‚ÑπÔ∏è No changes detected, skipping commit"
            exit 0
          fi

          git add manifest.json package.json package-lock.json versions.json
          git commit -m "Release: bump version to $VERSION [skip ci]" \
            -m "" \
            -m "Automated version bump after publishing release $VERSION"

          git push
